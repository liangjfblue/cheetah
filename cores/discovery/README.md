# 服务发现

参考go-micro实现的服务发现组件, 主要是可插拔的设计模式, 通过把服务发现, watch服务, 缓存服务cache分为不同模块, 通过接口和依赖注入的凡是,
大大提高了组件间的耦合, 从而实现可插拔的目的. 

## 插件化实现
- 函数选项模式
- 接口
- 依赖注入

服务发现主要是服务注册, 服务监听, 服务缓存. 其中比较重要的是数据一致性, 失败策略, 缓存提高效率等.

## 亮点
- 1.支持服务多版本并存, 一个服务多节点, 支持自定义元数据(metaData),方便携带定制化信息

- 2.通过cache来缓存服务信息, 提高了查询速度. 并且通过ttl来控制服务的缓存时间, 从而避免"死服务"的存在, 从而造成服务请求的异常.

- 3.因为cache的存在, 可以单独实现一个http, 提供Restful接口来查询服务发现的相关信息, 比如服务列表, 服务的节点列表, 服务信息, 节点信息等.

## 设计服务发现的相关笔记:

### 健康检查分为两个方法

- 客户端心跳
- 服务端TCP主动探测


### 如何获取IP
- 通过手动配置，然后我们解析对应的文件就可以获取
- 遍历网卡，第一个不为本地环回地址的 IP 地址，很多开源框架都是如此来获取的，比如netty，dubbo

### 如何获取port
通过配置文件

### 如何生成服务的元数据
- 服务Id(Id): 使用时间戳 + 机房 + 当前工作机器 + 序列号来生成
- 服务名(ServiceName)：通过配置文件里面手动配置来获取
- 版本(version)：服务的版本，通过配置文件里面配置来获取，有了版本就可以做类似灰度发布等功能。
- 注册时间(registerTime)：服务注册的时间戳

### kv设计
    key:    path/srvName
    value:  nodeInfo

nodeInfo

    Version   //版本号
    Path      //注册路径
    Env       //环境
    SrvName   //服务名
    Addr      //服务地址
    Hostname  //主机名（必须唯一）
    Status    //状态，1表示接收流量，2表示不接收
    Color     //灰度或集群标识  
    ...

